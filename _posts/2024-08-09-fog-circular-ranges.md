---
title: Fog, Circular Ranges and Further Edits
---

I got a little sidetracked this morning learning PowerShell so I could automate the blog posting process a little more easily, and it seems good enough for now. All sorts of small changes this week as I went about setting up the fog-of-war system to make the game a little more strategic and a lot more immersive, now that the player's view of the world is actually limited.

The first thing that was going to take some time to fix was the current range or radius system for tiles on the grid, which basically just cast a variable-sized square shape onto the tilemap grid to determine what fell in range. For fog, I wanted a more accurate visualization of line-of-sight, and perhaps bring about improvements to ranged attackers as well, using a circular shape of tiles rather than a box. A ton of time was spent on finding two separate algorithms, one for finding tiles along the outer edge and the other for finding all tiles within the circle, that would remain consistent and reduce performance less than relying entirely on the more expensive check for all tiles. Eventually, I compromised and made some of the logic for obtaining any tile within range available to the boundary checker, to ensure that there weren't any discrepancies. So now, attack ranges, LOS and soon-to-be fog visuals will be determined by the circular range of tiles around a unit, rather than the previous box projection.

![A screenshot of the game view with the Gizmos for visualizing attack and line-of-sight enabled on a ranged unit. The unit is surrounded by a jagged line approximating the curve of a circle with the edges of fixed-size tiles, with one larger circular ring for the unit's line-of-sight and the smaller ring for its attack range.](/../assets/images/blog/0016/tilecircle.png)

After this, I've been able to implement a very basic fog map for keeping track of the visible range of tiles, as well as previously explored tiles, per-affiliation. It's added quite a lot without much visual polish, and it's always nice to have something that nails the effect of the final product emerge from a fairly straightforward prototype. 

Currently, units which should be obscured by fog are still visible, which would be a fairly easy thing to fix, but one I have neglected because of the larger issue of factoring in what "should" be visible in all cases. Having to represent alternate versions of reality for each player in the non-visible areas (AOE: buildings can be destroyed, trees chopped, but the player is unaware without having them within a visible tile) is probably a more complex system than this rough and unoptimized one.

![A screenshot of the game view showing off the fog-of-war system with a few enemy and friendly units scattered around. The player's affiliation must be set to Friendly, as units within that faction display a circular range of visible tiles around themselves, bordered by either explored gray-tinted tiles or unexplored black tiles depending on whether the tiles had been made visible at some point in the past.](/../assets/images/blog/0016/fog.png)

On top of all this, further refactors and optimizations to systems that rely on unit positions and movement. With all the tile-centric mechanics, it made sense to start figuring out how to make more systems respond to tile-specific updates rather than continuously polling for information in `Update()`. Most of the edits so far have significantly improved performance, and the newly-exposed tile events should be useful for building up more mechanics around tile changes in the future.